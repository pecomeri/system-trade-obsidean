---
strategy: D001_m1_momentum_burst_range_only
filters:
  - W1 only
  - H1 filter ON (compute_h1_uptrend参照)
regime:
  - m1_compression
result: dead
---

# D002（family_D_momentum）：m1_compression 追加のみ

## 差分（D001から1つだけ）

- D001 からの差分は **regime: m1_compression を追加するだけ**
  - strategy（M1 momentum burst）は D001 と同一
  - execution（10秒足は執行補助 / 次の10秒open）は同一
  - filters（W1 only + H1 filter ON）は同一

## Regime（Contract）

- `FX/10_regimes/m1_compression.md` を正典とする（価格レンジのみ）

## m1_compression のロジック（要約）

入力：M1 確定足（10秒足→M1集約の open/close）

- レンジ定義は **M1実体レンジ**（`body = abs(close-open)`）に固定
- パラメータは固定（最適化しない）
  - `N = lookback_bars`（既存の固定値を流用）
  - `K = floor(N/2)`（派生固定）

擬似コード（実装一致の要点）：

```text
body = abs(m1_close - m1_open)
median_prev = rolling_median(body.shift(1), window=N)
is_small = (body < median_prev)
compression = (rolling_sum(is_small, window=K) == K)
compression_closed = shift1(compression)   # 直近の確定M1で判定
```

適用：`compression_closed == True` のときだけ、D001の burst シグナルを有効化（それ以外は no-trade）。

## 実装参照

- `FX/code/backtest_runner.py`
  - `HypConfig.regime_mode=\"m1_compression\"` のときのみ、D001シグナルに compression gate を追加

## 出力先

- `FX/results/family_D_momentum/D002/`

## 結果（2024 verify / 2025 forward）

集計（`FX/results/summary_family_D_momentum.csv`）：

- D002（m1_compression追加）
  - 2024 verify: `sum_pnl_pips=+8.0`, `trades=19`
  - 2025 forward: `sum_pnl_pips=-18.0`, `trades=26`
- D001（比較：regime無し）
  - 2024 verify: `sum_pnl_pips=-560.0`, `trades=485`
  - 2025 forward: `sum_pnl_pips=-198.0`, `trades=396`

比較メモ（観測のみ）：
- D002 は D001 に対して trade 数が大幅に減少（フィルタが強く、サンプルが小さい）
- forward はマイナスで、改善の再現性を主張できないため `dead` 扱い
